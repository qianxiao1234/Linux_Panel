<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æç®€ Linux ç›‘æ§</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background: #f5f5f5; }
        .container { max-width: 1200px; margin: auto; }
        h1 { color: #333; text-align: center; }
        .grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; }
        .card { background: white; border-radius: 8px; padding: 15px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .card h2 { margin-top: 0; font-size: 1.2em; border-bottom: 1px solid #eee; padding-bottom: 8px; }
        .stat-row { display: flex; justify-content: space-between; margin: 5px 0; }
        .progress { background: #e0e0e0; border-radius: 10px; height: 10px; width: 100%; margin-top: 5px; }
        .progress-bar { background: #4caf50; height: 10px; border-radius: 10px; width: 0%; }
        .value { font-weight: bold; }
        .error { color: red; text-align: center; }
        .footer { text-align: center; margin-top: 20px; color: #777; font-size: 0.9em; }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ§ Linux æœåŠ¡å™¨ç›‘æ§</h1>
        <div id="error" class="error"></div>
        <div class="grid" id="stats-grid">
            <!-- åŠ¨æ€å¡«å…… -->
        </div>
        <div class="footer">æ•°æ®æ¯ 1 ç§’æ›´æ–°ä¸€æ¬¡</div>
    </div>

    <script>
        // ä¸Šä¸€æ¬¡çš„ç½‘ç»œæµé‡å’Œæ—¶é—´æˆ³ï¼ˆç”¨äºè®¡ç®—é€Ÿç‡ï¼‰
        let lastNet = { sent: 0, recv: 0, timestamp: Date.now() };

        // æ ¼å¼åŒ–å­—èŠ‚
        function formatBytes(bytes) {
            if (bytes === 0) return '0 B';
            const k = 1024;
            const sizes = ['B', 'KB', 'MB', 'GB', 'TB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        // æ ¼å¼åŒ–è¿è¡Œæ—¶é—´ï¼ˆç§’ -> å¤©æ—¶åˆ†ç§’ï¼‰
        function formatUptime(seconds) {
            const days = Math.floor(seconds / 86400);
            const hours = Math.floor((seconds % 86400) / 3600);
            const minutes = Math.floor((seconds % 3600) / 60);
            const secs = Math.floor(seconds % 60);
            return `${days}å¤© ${hours}æ—¶ ${minutes}åˆ† ${secs}ç§’`;
        }

        // æ›´æ–°é¡µé¢æ•°æ®
        async function fetchStats() {
            try {
                const response = await fetch('/api/stats');
                if (!response.ok) throw new Error('ç½‘ç»œå“åº”é”™è¯¯');
                const data = await response.json();

                // è®¡ç®—ç½‘ç»œé€Ÿç‡
                const now = Date.now();
                const timeDelta = (now - lastNet.timestamp) / 1000; // ç§’
                let sentSpeed = 0, recvSpeed = 0;
                if (lastNet.timestamp && timeDelta > 0) {
                    sentSpeed = (data.network.bytes_sent - lastNet.sent) / timeDelta;
                    recvSpeed = (data.network.bytes_recv - lastNet.recv) / timeDelta;
                }
                // æ›´æ–°ä¸Šæ¬¡å€¼
                lastNet = {
                    sent: data.network.bytes_sent,
                    recv: data.network.bytes_recv,
                    timestamp: now
                };

                // æ„å»º HTML
                let html = '';

                // CPU å¡ç‰‡
                html += `<div class="card"><h2>ğŸ’» CPU</h2>`;
                html += `<div class="stat-row"><span>ä½¿ç”¨ç‡:</span><span class="value">${data.cpu_percent.toFixed(1)}%</span></div>`;
                html += `<div class="progress"><div class="progress-bar" style="width:${data.cpu_percent}%;"></div></div>`;
                html += `<div class="stat-row"><span>è´Ÿè½½ 1min:</span><span class="value">${data.load_avg[0].toFixed(2)}</span></div>`;
                html += `<div class="stat-row"><span>è´Ÿè½½ 5min:</span><span class="value">${data.load_avg[1].toFixed(2)}</span></div>`;
                html += `<div class="stat-row"><span>è´Ÿè½½ 15min:</span><span class="value">${data.load_avg[2].toFixed(2)}</span></div>`;
                html += `</div>`;

                // å†…å­˜å¡ç‰‡
                html += `<div class="card"><h2>ğŸ§  å†…å­˜</h2>`;
                html += `<div class="stat-row"><span>å·²ç”¨:</span><span class="value">${formatBytes(data.memory.used)} / ${formatBytes(data.memory.total)} (${data.memory.percent}%)</span></div>`;
                html += `<div class="progress"><div class="progress-bar" style="width:${data.memory.percent}%;"></div></div>`;
                html += `<div class="stat-row"><span>å¯ç”¨:</span><span class="value">${formatBytes(data.memory.available)}</span></div>`;
                html += `<div class="stat-row"><span>ç©ºé—²:</span><span class="value">${formatBytes(data.memory.free)}</span></div>`;
                html += `</div>`;

                // äº¤æ¢åˆ†åŒºå¡ç‰‡
                html += `<div class="card"><h2>ğŸ’¾ äº¤æ¢</h2>`;
                if (data.swap.total > 0) {
                    html += `<div class="stat-row"><span>å·²ç”¨:</span><span class="value">${formatBytes(data.swap.used)} / ${formatBytes(data.swap.total)} (${data.swap.percent}%)</span></div>`;
                    html += `<div class="progress"><div class="progress-bar" style="width:${data.swap.percent}%;"></div></div>`;
                } else {
                    html += `<div class="stat-row"><span>æœªå¯ç”¨æˆ–ä¸º 0</span></div>`;
                }
                html += `</div>`;

                // ç£ç›˜åˆ†åŒºå¡ç‰‡ï¼ˆå¯å¤šä¸ªï¼‰
                html += `<div class="card"><h2>ğŸ“ ç£ç›˜åˆ†åŒº</h2>`;
                data.disk_partitions.forEach(part => {
                    html += `<div style="margin-top:10px;"><strong>${part.mountpoint}</strong> (${part.device})</div>`;
                    html += `<div class="stat-row"><span>å·²ç”¨:</span><span class="value">${formatBytes(part.used)} / ${formatBytes(part.total)} (${part.percent}%)</span></div>`;
                    html += `<div class="progress"><div class="progress-bar" style="width:${part.percent}%;"></div></div>`;
                });
                if (data.disk_partitions.length === 0) html += `<div>æ— å¯ç”¨åˆ†åŒº</div>`;
                html += `</div>`;

                // ç½‘ç»œå¡ç‰‡
                html += `<div class="card"><h2>ğŸŒ ç½‘ç»œ</h2>`;
                html += `<div class="stat-row"><span>ä¸Šä¼  (ç´¯è®¡):</span><span class="value">${formatBytes(data.network.bytes_sent)}</span></div>`;
                html += `<div class="stat-row"><span>ä¸‹è½½ (ç´¯è®¡):</span><span class="value">${formatBytes(data.network.bytes_recv)}</span></div>`;
                html += `<div class="stat-row"><span>ä¸Šä¼ é€Ÿåº¦:</span><span class="value">${formatBytes(sentSpeed)}/s</span></div>`;
                html += `<div class="stat-row"><span>ä¸‹è½½é€Ÿåº¦:</span><span class="value">${formatBytes(recvSpeed)}/s</span></div>`;
                html += `</div>`;

                // è¿è¡Œæ—¶é—´å¡ç‰‡
                html += `<div class="card"><h2>â±ï¸ ç³»ç»Ÿ</h2>`;
                html += `<div class="stat-row"><span>è¿è¡Œæ—¶é—´:</span><span class="value">${formatUptime(data.uptime_seconds)}</span></div>`;
                const bootDate = new Date(data.boot_time * 1000).toLocaleString();
                html += `<div class="stat-row"><span>å¯åŠ¨æ—¶é—´:</span><span class="value">${bootDate}</span></div>`;
                html += `</div>`;

                document.getElementById('stats-grid').innerHTML = html;
                document.getElementById('error').innerText = '';
            } catch (err) {
                document.getElementById('error').innerText = 'è·å–æ•°æ®å¤±è´¥: ' + err.message;
            }
        }

        // åˆå§‹åŠ è½½ï¼Œç„¶åæ¯ 1 ç§’æ›´æ–°
        fetchStats();
        setInterval(fetchStats, 1000);
    </script>
</body>
</html>